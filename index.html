<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Progress Reading Group</title>
  <style>
    :root { --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --accent:#58a6ff; }
    html,body {
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--fg);
      font:16px/1.5 system-ui,Segoe UI,Inter,Arial,sans-serif
    }
    a { color:var(--accent); text-decoration:none }
    a:hover { text-decoration:underline }
    main { max-width:820px; margin:0 auto; padding:3rem 1rem }
    h1 {
      margin:0 0 1rem;
      font-size:1.6rem;
      font-family: Georgia, 'Times New Roman', Times, serif;
      font-weight: 400;
    }
    p.meta { color:var(--muted); margin:.25rem 0 1.25rem }
    ul { list-style:none; padding:0; margin:0 0 1.5rem 0 }

    /* Row */
    li.row {
      padding:.5rem .75rem;
      border-bottom:1px solid #30363d;
      display:flex;
      gap:.75rem;
      justify-content:space-between;
      align-items:center;           /* prevent any vertical wobble */
      transition: background-color .15s ease;
      cursor: pointer;              /* whole row is clickable */
    }
    /* Symmetric top border on the first row */
    #list > li.row:first-child {
      border-top:1px solid #30363d;
    }

    li.row:hover { background:#161b22; }
    li.row:focus { outline:2px solid var(--accent); outline-offset:2px; }

    .name {
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      transition: color .15s ease;
    }
    li.row:hover .name { color: var(--accent); }

    .right a svg {
      width: 20px;
      height: 20px;
      display: block;
      color: var(--accent);
      transition: color 0.2s ease, filter 0.2s ease;
    }
    /* Icon highlights with the row but doesn't move */
    li.row:hover .right a svg {
      filter: brightness(1.2);
    }
  </style>
</head>
<body>
<main>
  <h1>Progress Reading Group (PRG)</h1>
  <p class="meta">
    The PRG is a multidisciplinary reading group led by 
    <a href="https://x.com/_benjaminparry/status/1905297341705281898" target="_blank" rel="noopener">Benjamin Parry</a> 
    and <a href="https://www.linkedin.com/in/mixue/" target="_blank" rel="noopener">Michelle Jia</a>. 
    We read influential papers from many academic fields, and investigate them from the lens of progress. We meet weekly, in person, in Toronto.
  </p>
  <p class="meta">Here are the <span id="file-count"></span> papers we’ve read so far. Click the icon to download the PDF.</p>
  <ul id="list" aria-live="polite"></ul>
  <p class="meta">Last updated <span id="last-updated">—</span> via <a href="https://github.com/ellenli/progress" target="_blank" rel="noopener">GitHub</a>.</p>
</main>

<script>
(async () => {
  const OWNER = "ellenli";
  const REPO  = "progress";

  function formatDate(iso){
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
  }

  async function getRepoMeta() {
    const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}`);
    if (!r.ok) throw new Error('repo');
    return await r.json();
  }

  async function getPDFs(branch){
    const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${encodeURIComponent(branch)}?recursive=1`);
    if (!r.ok) throw new Error('tree');
    const data = await r.json();
    return (data.tree || [])
      .filter(n => n.type === 'blob' && /\.pdf$/i.test(n.path))
      .map(n => ({
        path: n.path,
        name: n.path.split('/').pop(),
        blob: `https://github.com/${OWNER}/${REPO}/blob/${branch}/${n.path}`,
        raw:  `https://raw.githubusercontent.com/${OWNER}/${REPO}/${branch}/${n.path}`
      }))
      .sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
  }

  function parseFileName(filename) {
    const base = filename.replace(/\.pdf$/i, '');
    const parts = base.split(' - ');
    if (parts.length < 4) return null;

    const sessionNum = parseInt(parts[0], 10);
    const year = parts[parts.length - 1];
    const author = parts[1];
    const title = parts.slice(2, parts.length - 1).join(' - ');

    return { sessionNum, title, author, year };
  }

  const list = document.getElementById('list');

  function render(items){
    list.innerHTML = items.map(f => {
      const parsed = parseFileName(f.name);
      if (!parsed) return '';
      return `<li class="row" data-href="${f.blob}" role="link" tabindex="0" aria-label="Open ${parsed.title} by ${parsed.author} on GitHub">
         <span class="name">${parsed.sessionNum}. ${parsed.title} by ${parsed.author} (${parsed.year})</span>
         <span class="right">
           <!-- Icon: force direct download of raw file -->
           <a href="${f.raw}" class="save" data-url="${f.raw}" data-name="${f.name}" rel="noopener" aria-label="Download PDF">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" focusable="false">
               <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
               <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
             </svg>
           </a>
         </span>
       </li>`;
    }).join('');
  }

  // Enforced direct-download helper with graceful fallback
  async function forceDownload(url, filename) {
    try {
      const res = await fetch(url, { mode: 'cors', cache: 'no-store' });
      if (!res.ok) throw new Error('fetch');
      const blob = await res.blob();
      const objectUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = objectUrl;
      a.download = filename || 'file.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(objectUrl);
    } catch (_) {
      // Fallback: try native download attribute
      const a = document.createElement('a');
      a.href = url;
      a.setAttribute('download', filename || 'file.pdf');
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  }

  // Row click & keyboard navigation -> GitHub blob
  list.addEventListener('click', (e) => {
    const saveLink = e.target.closest && e.target.closest('a.save');
    if (saveLink) {
      e.preventDefault();
      forceDownload(saveLink.dataset.url, saveLink.dataset.name);
      return;
    }
    const row = e.target.closest('li.row');
    if (!row) return;
    const url = row.getAttribute('data-href');
    if (url) window.open(url, '_blank', 'noopener');
  });

  list.addEventListener('keydown', (e) => {
    const row = e.target.closest && e.target.closest('li.row');
    if (!row) return;
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const url = row.getAttribute('data-href');
      if (url) window.open(url, '_blank', 'noopener');
    }
  });

  try {
    const meta = await getRepoMeta();
    const branch = meta.default_branch || 'main';
    const files = await getPDFs(branch);

    document.getElementById('file-count').textContent = files.length;
    document.getElementById('last-updated').textContent = formatDate(meta.pushed_at);

    render(files);
  } catch(e) {
    list.innerHTML = '<li>Unable to load list.</li>';
  }
})();
</script>
</body>
</html>