<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF Index</title>
  <style>
    :root { --bg:#0d1117; --fg:#c9d1d9; --muted:#8b949e; --card:#161b22; --accent:#58a6ff; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    header{padding:2rem 1rem 1rem;max-width:920px;margin:0 auto}
    h1{margin:0 0 .5rem;font-size:1.75rem}
    .row{max-width:920px;margin:0 auto;padding:0 1rem 2rem}
    .controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    input[type="search"]{flex:1;min-width:240px;padding:.6rem .8rem;border-radius:.6rem;border:1px solid #30363d;background:var(--card);color:var(--fg)}
    select{padding:.55rem .7rem;border-radius:.6rem;border:1px solid #30363d;background:var(--card);color:var(--fg)}
    .grid{display:grid;grid-template-columns:1fr;gap:.75rem;margin-top:1rem}
    .card{background:var(--card);border:1px solid #30363d;border-radius:.8rem;padding:.9rem .95rem}
    .path{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.9rem;word-break:break-all}
    .meta{margin-top:.25rem;color:var(--muted);font-size:.85rem;display:flex;gap:1rem;flex-wrap:wrap}
    .links{margin-top:.5rem;display:flex;gap:.75rem;flex-wrap:wrap}
    footer{padding:2rem 1rem;color:var(--muted);text-align:center}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <h1>PDF Index</h1>
    <div class="controls">
      <input id="q" type="search" placeholder="Filter by name or folder…">
      <select id="groupBy">
        <option value="none">Sort: A → Z</option>
        <option value="folder">Group by folder</option>
      </select>
      <span id="repoInfo" class="muted"></span>
    </div>
  </header>

  <div class="row">
    <div id="status" class="meta"></div>
    <div id="list" class="grid"></div>
  </div>

  <footer>
    This page discovers PDFs via the GitHub API (git trees). It always reflects the latest commit on the default branch.
  </footer>

<script>
(async () => {
  // --- You may optionally hardcode these if auto-detection doesn't fit your setup ---
  let OWNER = "";        // e.g. "ellenli"
  let REPO  = "";        // e.g. "progress"
  let BRANCH = "";       // leave empty to look up the default branch

  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('list');
  const qEl = document.getElementById('q');
  const groupSel = document.getElementById('groupBy');
  const repoInfo = document.getElementById('repoInfo');

  // Try to infer owner/repo when hosted on GitHub Pages (username.github.io/repo)
  try {
    const host = location.hostname;
    const pathParts = location.pathname.replace(/^\\/+/, '').split('/').filter(Boolean);
    if (!OWNER && host.endsWith('.github.io') && pathParts.length >= 1) {
      OWNER = host.split('.')[0];
      REPO = pathParts[0];
    }
    // Optional meta overrides:
    const mRepo = document.querySelector('meta[name="x-repo"][content]');
    const mOwner = document.querySelector('meta[name="x-owner"][content]');
    if (mRepo) REPO = REPO || mRepo.getAttribute('content');
    if (mOwner) OWNER = OWNER || mOwner.getAttribute('content');
  } catch(e) {}

  function setStatus(msg){ statusEl.textContent = msg; }

  if (!OWNER || !REPO) {
    setStatus("Set OWNER and REPO at the top of the script.");
    return;
  }

  // Look up default branch if not provided
  async function getDefaultBranch() {
    if (BRANCH) return BRANCH;
    const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}`);
    if (!r.ok) throw new Error('Repo lookup failed');
    const meta = await r.json();
    repoInfo.textContent = `${OWNER}/${REPO} • default: ${meta.default_branch}`;
    return meta.default_branch || 'main';
  }

  // Fetch full tree (recursive) and filter PDFs
  async function fetchPDFs(branch) {
    setStatus('Scanning repository…');
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('Tree fetch failed');
    const data = await r.json();
    const items = (data.tree || []).filter(n => n.type === 'blob' && /\.pdf$/i.test(n.path));
    return items.map(n => ({
      path: n.path,
      size: n.size || 0,
      folder: n.path.includes('/') ? n.path.split('/').slice(0,-1).join('/') : '',
      name: n.path.split('/').pop(),
      rawUrl: `https://raw.githubusercontent.com/${OWNER}/${REPO}/${branch}/${n.path}`,
      blobUrl: `https://github.com/${OWNER}/${REPO}/blob/${branch}/${n.path}`
    })).sort((a,b)=> a.path.localeCompare(b.path, undefined, {sensitivity:'base'}));
  }

  const branch = await getDefaultBranch().catch(() => setStatus('Unable to determine default branch.'));
  if (!branch) return;

  const files = await fetchPDFs(branch).catch(() => setStatus('Unable to fetch repository tree.'));
  if (!files) return;
  setStatus(`${files.length} PDF${files.length===1?'':'s'} found on ${branch}.`);

  // Render
  function render() {
    const q = qEl.value.trim().toLowerCase();
    const groupByFolder = groupSel.value === 'folder';
    listEl.innerHTML = '';

    let visible = files.filter(f => !q || f.path.toLowerCase().includes(q));

    if (groupByFolder) {
      const groups = {};
      visible.forEach(f => { (groups[f.folder||'(root)'] ||= []).push(f); });
      Object.keys(groups).sort().forEach(folder => {
        const section = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'meta';
        header.textContent = folder || '(root)';
        section.appendChild(header);
        groups[folder].forEach(f => section.appendChild(cardFor(f)));
        listEl.appendChild(section);
      });
    } else {
      visible.forEach(f => listEl.appendChild(cardFor(f)));
    }
  }

  function humanSize(bytes){
    if (!bytes) return '—';
    const units=['B','KB','MB','GB']; let i=0; let n=bytes;
    while (n>=1024 && i<units.length-1){ n/=1024; i++; }
    return n.toFixed(n<10&&i>0?1:0) + ' ' + units[i];
  }

  function cardFor(file){
    const div = document.createElement('div');
    div.className = 'card';
    const name = document.createElement('div');
    name.className = 'path';
    name.textContent = file.name;
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = (file.folder ? file.folder + ' • ' : '') + humanSize(file.size);
    const links = document.createElement('div');
    links.className = 'links';
    links.innerHTML = `<a href="${file.blobUrl}" target="_blank" rel="noopener">View on GitHub</a>
                        <a href="${file.rawUrl}" target="_blank" rel="noopener" download>Download</a>`;
    div.appendChild(name);
    div.appendChild(meta);
    div.appendChild(links);
    return div;
  }

  qEl.addEventListener('input', render);
  groupSel.addEventListener('change', render);

  render();
})();
</script>
</body>
</html>
